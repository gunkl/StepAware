name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  quick-check:
    name: Quick Checks (<30s)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for trailing whitespace
        run: |
          echo "Checking for trailing whitespace in source files..."
          if git grep -I --line-number '\s$' -- '*.cpp' '*.h' '*.py' '*.md' ':!*.patch' ':!.pio/*'; then
            echo "::error::Trailing whitespace found (see above)"
            exit 1
          fi
          echo "âœ… No trailing whitespace found"

      - name: Check build number validity
        run: |
          echo "Validating build_number.txt format..."
          if ! grep -E '^[0-9]+$' build_number.txt; then
            echo "::error::Invalid build_number.txt - must contain only digits"
            cat build_number.txt
            exit 1
          fi
          echo "âœ… Build number is valid: $(cat build_number.txt)"

      - name: Check for large files
        run: |
          echo "Checking for large files (>1MB)..."
          large_files=$(find . -type f -size +1M | grep -v '.git' | grep -v '.pio' | grep -v 'node_modules' || true)
          if [ -n "$large_files" ]; then
            echo "::warning::Large files found (consider .gitignore or Git LFS):"
            echo "$large_files"
          else
            echo "âœ… No large files found"
          fi

      - name: Check for common issues
        run: |
          echo "Checking for common code issues..."
          # Check for debug print statements
          if git grep -n 'console\.log\|Serial\.print.*DEBUG' -- '*.cpp' '*.h' ':!test/*'; then
            echo "::warning::Debug print statements found - consider removing before production"
          fi
          echo "âœ… Quick checks complete"

  lint:
    name: Code Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Run PlatformIO check
        run: pio check --fail-on-defect=medium --environment native

      - name: Generate linting summary
        if: always()
        run: |
          echo "### ðŸ“Š Linting Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: native only (ESP32C3 skipped due to cppcheck issues)" >> $GITHUB_STEP_SUMMARY
          echo "- **Suppressions**: cppcheck-suppressions.txt (see docs/CI_LINTING.md)" >> $GITHUB_STEP_SUMMARY
          echo "- **Threshold**: medium+ defects" >> $GITHUB_STEP_SUMMARY
          echo "- **Files checked**: C++ source and headers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ $? -eq 0 ]; then
            echo "âœ… **Status**: All checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Linting failed - see output above" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Provide linting guidance on failure
        if: failure()
        run: |
          echo "::error::Code linting failed - see cppcheck output above"
          echo "::notice::Run locally: pio check --environment native --fail-on-defect=medium -v"
          echo "::notice::Documentation: docs/CI_LINTING.md"
          echo "::notice::Suppressions: cppcheck-suppressions.txt"
          echo "::notice::For help, see: .github/workflows/README.md#lint-job-fails"

  # Python Unit Tests - Runs standalone Python tests directly
  # Note: C++ Unity tests run separately in 'test-native' job via PlatformIO
  test-python-unit:
    name: Python Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install test dependencies if requirements.txt exists
          if [ -f test/requirements.txt ]; then pip install -r test/requirements.txt; fi

      - name: Run Python unit tests
        run: |
          # Run standalone Python tests directly (not via run_tests.py)
          cd test
          test_count=0
          for test_file in test_*.py; do
            if [ -f "$test_file" ] && [ "$test_file" != "test_runner.py" ]; then
              echo "=========================================="
              echo "Running $test_file..."
              echo "=========================================="
              python3 "$test_file" || exit 1
              test_count=$((test_count + 1))
            fi
          done
          echo "âœ… All $test_count Python test files passed"

      - name: Generate test summary
        if: always()
        run: |
          echo "### ðŸ§ª Python Unit Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test files executed**: Standalone Python tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test categories**:" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration manager (test_config_manager.py)" >> $GITHUB_STEP_SUMMARY
          echo "- HAL components (test_hal_*.py)" >> $GITHUB_STEP_SUMMARY
          echo "- State machine (test_state_transitions.py)" >> $GITHUB_STEP_SUMMARY
          echo "- Web API (test_web_api.py)" >> $GITHUB_STEP_SUMMARY
          echo "- Logger (test_logger.py)" >> $GITHUB_STEP_SUMMARY
          echo "- And more..." >> $GITHUB_STEP_SUMMARY

      - name: Provide Python test guidance on failure
        if: failure()
        run: |
          echo "::error::Python unit tests failed - see test output above"
          echo "::notice::Run locally: cd test && for f in test_*.py; do python3 \"\$f\"; done"
          echo "::notice::Check for missing dependencies or mock configuration issues"
          echo "::notice::For help, see: .github/workflows/README.md#python-test-job-fails"

  build-firmware:
    name: Build ESP32 Firmware
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build ESP32 firmware
        run: pio run -e esp32c3

      - name: Check firmware size
        run: pio run -e esp32c3 --target size

      - name: Generate build summary
        if: always()
        run: |
          echo "### ðŸ”§ Firmware Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ESP32-C3" >> $GITHUB_STEP_SUMMARY
          echo "**Output**: .pio/build/esp32c3/firmware.bin" >> $GITHUB_STEP_SUMMARY
          if [ -f .pio/build/esp32c3/firmware.bin ]; then
            size=$(stat -c%s .pio/build/esp32c3/firmware.bin 2>/dev/null || stat -f%z .pio/build/esp32c3/firmware.bin)
            size_kb=$((size / 1024))
            echo "**Firmware size**: ${size_kb} KB" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Status**: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status**: Build failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware
          path: .pio/build/esp32c3/firmware.bin
          retention-days: 30

  test-native:
    name: Native C++ Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio/.cache
            ~/.platformio/packages
            ~/.platformio/platforms
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Install GCC
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Run native tests
        run: pio test -e native -v

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: .pio/test/
          retention-days: 30

  test-docker:
    name: Docker Environment Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: docker compose build

      - name: Run tests in Docker
        run: docker compose run --rm stepaware-dev pio test -e native

      - name: Build firmware in Docker
        run: docker compose run --rm stepaware-dev pio run -e esp32c3

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [quick-check, lint, test-python-unit, build-firmware, test-native, test-docker]
    if: always()

    steps:
      - name: Generate build summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Function to get status emoji
          get_status_emoji() {
            case "$1" in
              success) echo "âœ…" ;;
              failure) echo "âŒ" ;;
              skipped) echo "â­ï¸" ;;
              cancelled) echo "ðŸš«" ;;
              *) echo "â“" ;;
            esac
          }

          echo "| Quick Checks | $(get_status_emoji ${{ needs.quick-check.result }}) ${{ needs.quick-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Linting | $(get_status_emoji ${{ needs.lint.result }}) ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Unit Tests | $(get_status_emoji ${{ needs.test-python-unit.result }}) ${{ needs.test-python-unit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Firmware | $(get_status_emoji ${{ needs.build-firmware.result }}) ${{ needs.build-firmware.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Native C++ Tests | $(get_status_emoji ${{ needs.test-native.result }}) ${{ needs.test-native.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Tests | $(get_status_emoji ${{ needs.test-docker.result }}) ${{ needs.test-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.quick-check.result }}" == "success" ] && \
             [ "${{ needs.lint.result }}" == "success" ] && \
             [ "${{ needs.test-python-unit.result }}" == "success" ] && \
             [ "${{ needs.build-firmware.result }}" == "success" ] && \
             [ "${{ needs.test-native.result }}" == "success" ] && \
             [ "${{ needs.test-docker.result }}" == "success" ]; then
            echo "### âœ… All checks passed! Pipeline is green." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Pipeline failed - see job details above" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting**: See [CI/CD Documentation](.github/workflows/README.md)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
